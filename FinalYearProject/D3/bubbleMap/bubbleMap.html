<!DOCTYPE html>
<meta charset="utf-8">
<style>

.subunit.DEU { fill: #ddc; }

.place,
.place-label {
  fill: #444;
}

.subunit-label {
  fill: #777;
  fill-opacity: .5;
  font-size: 20px;
  font-weight: 300;
  text-anchor: middle;
}

.states {
  fill: #ccc;
  stroke: #fff;
}

.bubble {
  fill: brown;
  fill-opacity: .5;
  stroke: #fff;
  stroke-width: .5px;
}

.legend circle {
  fill: none;
  stroke: #ccc;
}

.legend text {
  fill: #777;
  font: 10px sans-serif;
  text-anchor: middle;
}

text {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-size: 10px;
  pointer-events: none;
}

</style>
<body>
<script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="//d3js.org/queue.v1.min.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
<script>
var width = 960,
    height = 1160;

var projection = d3.geo.albers()
    .center([12, 49.5])
    .rotate([4.4, 0])
    .parallels([50, 60])
    .scale(5500)
    .translate([width / 2, height / 2]);

var radius = d3.scale.sqrt()
    .domain([0, 5e1])
    .range([0, 15]);

var path = d3.geo.path()
    .projection(projection)
    .pointRadius(2);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

// var legend = svg.append("g")
//     .attr("class", "legend")
//     .attr("transform", "translate(" + (width - 50) + "," + (height - 400) + ")")
//   .selectAll("g")
//     .data([2e1, 5e1, 1e2, 1e3])
//   .enter().append("g");

//   legend.append("circle")
//     .attr("cy", function(d) { return -radius(d); })
//     .attr("r", radius);

//   legend.append("text")
//     .attr("y", function(d) { return -2 * radius(d); })
//     .attr("dy", "1.3em")
//     .text(d3.format(".1s"));

queue()
    .defer(d3.json, "germany.json")
    .defer(d3.csv, "data.csv")
    .await(ready);

function ready(error, germany, data) {
  if (error) throw error;

    var subunits = topojson.feature(germany, germany.objects.subunits);
    var places = topojson.feature(germany, germany.objects.places);

    svg.selectAll(".subunit")
        .data(subunits.features)
        .enter().append("path")
        .attr("class", function(d) { return "subunit " + d.id; })
        .attr("d", path);

    svg.append("path")
      .datum(places)
      .attr("d", path)
      .attr("class", "place");

    svg.selectAll(".subunit-label")
      .data(subunits.features)
        .enter().append("text")
      .attr("class", function(d) { return "subunit-label " + d.id; })
      .attr("transform", function(d) { return "translate(" + path.centroid(d) + ")"; })
      .attr("dy", ".35em")
      .text(function(d) { return d.properties.name; });

    svg.selectAll(".place-label")
      .data(places.features)
    .enter().append("text")
      .attr("class", "place-label")
      .attr("transform", function(d) { return "translate(" + projection(d.geometry.coordinates) + ")"; })
      .attr("x", function(d) { return d.geometry.coordinates[0] > -1 ? 6 : -6; })
      .attr("dy", ".35em")
      .style("text-anchor", function(d) { return d.geometry.coordinates[0] > -1 ? "start" : "end"; })
      .text(function(d) { return d.properties.name; });

    svg.selectAll("circle")
           .data(data)
           .sort(function(a, b) { return b.quantity - a.quantity; })
           .enter()
           .append("circle")
           .attr("class", "bubble")
           .attr("cx", function(d) {
                   return projection([d.lon, d.lat])[0];
           })
           .attr("cy", function(d) {
                   return projection([d.lon, d.lat])[1];
           })
           .attr("r", function(d) {
              if (d.quantity < 50) {
                return d.quantity/3;
              } else if (d.quantity < 50) {
                   return d.quantity/5;
              } else if (d.quantity < 100) {
                   return d.quantity/10;
              }  else {
                return d.quantity/100;
              }
           })
           .style("fill", "red");
};

</script>
</body>
